<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AFL Draft ‚Äî Market Allocation</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#050816;
      --bg1:#060b1f;
      --card:#0b1330cc;
      --stroke:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --accent:#45d4ff;
      --accent2:#7c4dff;
      --good:#2cff9a;
      --bad:#ff4d5a;
      --gold:#FFD700;
      --silver:#C0C0C0;
      --bronze:#CD7F32;
    }

    body{
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(124,77,255,.25), transparent 55%),
        radial-gradient(900px 500px at 85% 10%, rgba(69,212,255,.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .glass{
      background: var(--card);
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      border-radius: 20px;
    }

    .hero{
      position: relative;
      padding: 28px 0 8px;
    }

    .hero-badge{
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      padding: .45rem .75rem;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-weight: 600;
      letter-spacing: .2px;
    }

    .hero-title{
      font-weight: 800;
      letter-spacing: -0.6px;
      line-height: 1.05;
      margin-top: 14px;
      margin-bottom: 10px;
    }

    .hero-sub{
      color: var(--muted);
      max-width: 70ch;
    }

    .pulse-dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
      box-shadow: 0 0 0 0 rgba(44,255,154,.45);
      animation: pulse 1.8s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(44,255,154,.45); }
      70% { box-shadow: 0 0 0 10px rgba(44,255,154,0); }
      100% { box-shadow: 0 0 0 0 rgba(44,255,154,0); }
    }

    .status-pill{
      border-radius: 999px;
      padding: .45rem .75rem;
      font-weight: 700;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      display: inline-flex;
      align-items: center;
      gap: .55rem;
      white-space: nowrap;
    }

    .mini{
      color: var(--muted);
      font-size: .92rem;
    }

    .divider{
      height: 1px;
      background: var(--stroke);
      margin: 12px 0;
    }

    .chart-wrap{
      position: relative;
      height: 360px;
    }

    .table thead th{
      color: rgba(255,255,255,.8);
      font-weight: 800;
      border-bottom-color: var(--stroke) !important;
    }
    .table tbody td{
      border-top-color: rgba(255,255,255,.06) !important;
      vertical-align: middle;
    }

    .rank-chip{
      font-weight: 800;
      border-radius: 999px;
      padding: .3rem .65rem;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      display: inline-flex;
      align-items: center;
      gap: .35rem;
    }

    .pick-chip{
      font-weight: 800;
      border-radius: 999px;
      padding: .3rem .65rem;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(69,212,255,.10);
      color: rgba(255,255,255,.92);
    }

    .final-banner{
      display:none;
      border: 1px solid rgba(255,77,90,.25);
      background: linear-gradient(90deg, rgba(255,77,90,.15), rgba(255,77,90,.05));
      padding: .75rem 1rem;
      border-radius: 16px;
      font-weight: 800;
      letter-spacing: .3px;
    }

    .skeleton{
      background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.11), rgba(255,255,255,.06));
      background-size: 200% 100%;
      animation: shimmer 1.4s infinite;
      border-radius: 12px;
    }
    @keyframes shimmer{
      0%{ background-position: 200% 0; }
      100%{ background-position: -200% 0; }
    }

    .toast-container{
      position: fixed;
      bottom: 18px;
      right: 18px;
      z-index: 1080;
    }

    .foot{
      color: var(--muted);
      font-size: .92rem;
    }

    canvas { user-select: none; }
  </style>
</head>
<body>

  <div class="container py-4">
    <!-- HERO -->
    <div class="hero">
      <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
        <div>
          <div class="hero-badge">
            <i class="bi bi-graph-up-arrow"></i>
            ASX-powered draft allocation ‚Ä¢ Picks <span class="text-white">7‚Äì14</span>
          </div>

          <h1 class="hero-title display-6">
            üèâ AFL Draft Ladder<br class="d-none d-md-block"/>
            <span style="background:linear-gradient(90deg,var(--accent),var(--accent2)); -webkit-background-clip:text; background-clip:text; color:transparent;">
              The Market Decides
            </span>
          </h1>

          <p class="hero-sub mb-0">
            8 managers. 8 ASX stocks. One trading day. Best daily % change earns the earliest remaining pick.
          </p>
        </div>

        <div class="glass p-3" style="min-width: 280px;">
          <div class="d-flex justify-content-between align-items-center">
            <div class="status-pill" id="marketPill">
              <span class="pulse-dot" id="pulseDot" style="background: var(--good);"></span>
              <span id="marketText">Checking market‚Ä¶</span>
            </div>
            <span class="badge rounded-pill text-bg-dark border" style="border-color: var(--stroke) !important;">
              <i class="bi bi-arrow-repeat"></i> 10m
            </span>
          </div>

          <div class="divider"></div>

          <div class="d-flex justify-content-between">
            <div class="mini">
              <div class="fw-bold text-white">Next update</div>
              <div id="nextUpdate">‚Äî</div>
            </div>
            <div class="mini text-end">
              <div class="fw-bold text-white">Countdown</div>
              <div id="countdown">‚Äî</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="mini">
            <i class="bi bi-clock-history"></i>
            <span class="fw-bold text-white">Last updated:</span>
            <span id="lastUpdated">‚Äî</span>
          </div>

          <div class="mt-3 final-banner" id="finalBanner">
            <i class="bi bi-lock-fill"></i> FINAL RESULTS LOCKED
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN GRID -->
    <div class="row g-3 mt-1">
      <!-- Chart -->
      <div class="col-12 col-lg-7">
        <div class="glass p-3 p-md-4">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
            <div>
              <div class="fw-bold">Live draft allocation</div>
              <div class="mini">Sorted by % change (day). Top performer gets <span class="text-white fw-bold">Pick 7</span>.</div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="badge rounded-pill" style="background:rgba(255,215,0,.15); border:1px solid rgba(255,215,0,.2);">
                <i class="bi bi-trophy-fill"></i> Pick 7 highlighted
              </span>
              <button class="btn btn-sm btn-outline-light" id="forceRefreshBtn">
                <i class="bi bi-arrow-clockwise"></i> Refresh now
              </button>
            </div>
          </div>

          <div class="chart-wrap">
            <canvas id="chart"></canvas>
          </div>

          <div class="mini mt-3">
            Data source: Yahoo Finance quotes (via CORS proxy). This is for fun, not trading.
          </div>
        </div>
      </div>

      <!-- Ladder Table -->
      <div class="col-12 col-lg-5">
        <div class="glass p-3 p-md-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <div class="fw-bold">Draft ladder</div>
              <div class="mini">Final daily % locks at market close (16:00 Sydney).</div>
            </div>
            <span class="badge rounded-pill text-bg-dark border" style="border-color: var(--stroke) !important;">
              <i class="bi bi-shield-check"></i> Commissioner approved
            </span>
          </div>

          <!-- ‚úÖ Error box so you can SEE when proxies are blocked -->
          <div id="errorBox" class="alert alert-danger d-none mt-3 mb-0" role="alert"></div>

          <div id="tableLoading" class="mt-3">
            <div class="skeleton mb-2" style="height: 42px;"></div>
            <div class="skeleton mb-2" style="height: 42px;"></div>
            <div class="skeleton mb-2" style="height: 42px;"></div>
            <div class="skeleton mb-2" style="height: 42px;"></div>
            <div class="skeleton mb-2" style="height: 42px;"></div>
          </div>

          <div class="table-responsive" id="tableWrap" style="display:none;">
            <table class="table table-dark table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th style="width: 88px;">Rank</th>
                  <th style="width: 96px;">Pick</th>
                  <th>Manager</th>
                  <th class="text-end">% Day</th>
                </tr>
              </thead>
              <tbody id="ladderBody"></tbody>
            </table>
          </div>

          <div class="divider"></div>

          <div class="d-flex justify-content-between foot">
            <div><i class="bi bi-geo-alt"></i> Sydney time</div>
            <div><i class="bi bi-calendar2-week"></i> Resets next trading day</div>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center mt-4 foot">
      ASX hours: 10:00‚Äì16:00 Sydney ‚Ä¢ Updates every 10 minutes ‚Ä¢ Picks assigned 7‚Äì14
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const REFRESH_MS = 10 * 60 * 1000; // 10 minutes

    const stocks = [
      { manager: "Jeremy", ticker: "CSL.AX" },
      { manager: "Callum", ticker: "BHP.AX" },
      { manager: "Darrell", ticker: "WBC.AX" },
      { manager: "Damian", ticker: "WES.AX" },
      { manager: "Chris", ticker: "CBA.AX" },
      { manager: "Ryan", ticker: "RIO.AX" },
      { manager: "James", ticker: "MQG.AX" },
      { manager: "Tom", ticker: "NAB.AX" }
    ];

    let chart;
    let locked = false;

    const LOCK_DATE_KEY = "draftMarketLockedDateSydney";
    const FINAL_DATA_KEY = "draftMarketFinalResultsSydney"; // { date, results }

    // --- Sydney time helpers ---
    function getSydneyDateObj(){
      const now = new Date();
      return new Date(now.toLocaleString("en-US", { timeZone: "Australia/Sydney" }));
    }
    function sydneyYMD(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function minutesSinceMidnightSydney(){
      const t = getSydneyDateObj();
      return t.getHours() * 60 + t.getMinutes();
    }
    function isMarketOpenSydney(){
      const m = minutesSinceMidnightSydney();
      return m >= 600 && m < 960; // 10:00‚Äì16:00
    }
    function isAfterCloseSydney(){
      return minutesSinceMidnightSydney() >= 960; // 16:00+
    }

    // --- UI helpers ---
    function updateMarketUI(){
      const open = isMarketOpenSydney();
      const pill = document.getElementById("marketPill");
      const dot = document.getElementById("pulseDot");
      const txt = document.getElementById("marketText");
      const banner = document.getElementById("finalBanner");

      if (locked){
        txt.textContent = "Market closed ‚Ä¢ Locked";
        dot.style.background = "var(--bad)";
        dot.style.animation = "none";
        pill.style.background = "rgba(255,77,90,.10)";
        pill.style.borderColor = "rgba(255,77,90,.25)";
        banner.style.display = "block";
        return;
      }

      banner.style.display = "none";

      if (open){
        txt.textContent = "Market OPEN";
        dot.style.background = "var(--good)";
        dot.style.animation = "";
        pill.style.background = "rgba(44,255,154,.08)";
        pill.style.borderColor = "rgba(44,255,154,.20)";
      } else {
        txt.textContent = "Market CLOSED";
        dot.style.background = "var(--bad)";
        dot.style.animation = "none";
        pill.style.background = "rgba(255,77,90,.08)";
        pill.style.borderColor = "rgba(255,77,90,.20)";
      }
    }

    function setLastUpdated(){
      document.getElementById("lastUpdated").textContent =
        new Date().toLocaleString("en-AU", { timeZone: "Australia/Sydney" });
    }

    function showError(msg){
      const box = document.getElementById("errorBox");
      box.classList.remove("d-none");
      box.textContent = msg;
    }
    function clearError(){
      document.getElementById("errorBox").classList.add("d-none");
      document.getElementById("errorBox").textContent = "";
    }

    // --- Fetch with proxy fallback (3 options) ---
    async function fetchWithFallback(yahooUrl){
      const proxies = [
        (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
        (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`,
        (u) => `https://r.jina.ai/http://${u.replace(/^https?:\/\//, "")}`
      ];

      let lastErr;

      for (const p of proxies){
        try{
          const res = await fetch(p(yahooUrl), { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const text = await res.text();
          const jsonStart = text.indexOf("{");
          if (jsonStart === -1) throw new Error("No JSON returned");
          const cleaned = text.slice(jsonStart);

          return JSON.parse(cleaned);
        } catch (e){
          lastErr = e;
        }
      }

      throw lastErr || new Error("Failed to fetch");
    }

    async function fetchAllStocks(){
      const symbols = stocks.map(s => s.ticker).join(",");
      const yahooUrl = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(symbols)}`;
      const data = await fetchWithFallback(yahooUrl);

      const map = new Map();
      for (const item of (data.quoteResponse?.result || [])){
        map.set(item.symbol, item.regularMarketChangePercent);
      }
      return map;
    }

    // --- Render ---
    function colorForIndex(i, v){
      if (i === 0) return "#FFD700";
      if (i === 1) return "#C0C0C0";
      if (i === 2) return "#CD7F32";
      return v >= 0 ? "#2cff9a" : "#ff4d5a";
    }

    function render(results, isFinal){
      document.getElementById("tableLoading").style.display = "none";
      document.getElementById("tableWrap").style.display = "block";

      const tbody = document.getElementById("ladderBody");
      tbody.innerHTML = "";

      results.forEach((r, i) => {
        const pick = 7 + i;
        const pct = Number.isFinite(r.percent) ? r.percent : null;

        const row = document.createElement("tr");
        if (isFinal) row.classList.add("table-active");

        row.innerHTML = `
          <td><span class="rank-chip">#${i + 1}</span></td>
          <td><span class="pick-chip">Pick ${pick}</span></td>
          <td class="fw-semibold">${r.manager}</td>
          <td class="text-end">
            ${
              pct === null
                ? `<span class="badge rounded-pill text-bg-secondary">N/A</span>`
                : `<span class="badge rounded-pill" style="background:${pct>=0?'rgba(44,255,154,.12)':'rgba(255,77,90,.12)'}; border:1px solid ${pct>=0?'rgba(44,255,154,.25)':'rgba(255,77,90,.25)'};">
                    ${pct.toFixed(2)}%
                  </span>`
            }
          </td>
        `;
        tbody.appendChild(row);
      });

      const labels = results.map((r, i) => `Pick ${7+i} ‚Äî ${r.manager}`);
      const values = results.map(r => Number.isFinite(r.percent) ? r.percent : 0);
      const colors = results.map((r, i) => colorForIndex(i, Number.isFinite(r.percent) ? r.percent : 0));

      const ctx = document.getElementById("chart").getContext("2d");
      const options = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { display: false }, ticks: { color: "rgba(255,255,255,.75)" } },
          y: { grid: { color: "rgba(255,255,255,.07)" }, ticks: { color: "rgba(255,255,255,.75)", callback: v => v + "%" } }
        }
      };

      if (!chart){
        chart = new Chart(ctx, {
          type: "bar",
          data: { labels, datasets: [{ data: values, backgroundColor: colors, borderRadius: 10 }] },
          options
        });
      } else {
        chart.data.labels = labels;
        chart.data.datasets[0].data = values;
        chart.data.datasets[0].backgroundColor = colors;
        chart.update();
      }
    }

    // --- Persistence: lock + final results cache ---
    function saveFinalResults(todaySydney, results){
      localStorage.setItem(FINAL_DATA_KEY, JSON.stringify({ date: todaySydney, results }));
      localStorage.setItem(LOCK_DATE_KEY, todaySydney);
    }

    function loadFinalResults(todaySydney){
      const raw = localStorage.getItem(FINAL_DATA_KEY);
      if (!raw) return null;
      try{
        const parsed = JSON.parse(raw);
        if (parsed?.date === todaySydney && Array.isArray(parsed.results)) return parsed.results;
      } catch {}
      return null;
    }

    function hydrateLockState(){
      const today = sydneyYMD(getSydneyDateObj());
      const lockedDate = localStorage.getItem(LOCK_DATE_KEY);

      locked = (lockedDate === today);

      // new day ‚Üí clear old lock and old cached results
      if (!locked){
        localStorage.removeItem(LOCK_DATE_KEY);
        const cached = localStorage.getItem(FINAL_DATA_KEY);
        if (cached){
          try{
            const parsed = JSON.parse(cached);
            if (parsed?.date !== today) localStorage.removeItem(FINAL_DATA_KEY);
          } catch {
            localStorage.removeItem(FINAL_DATA_KEY);
          }
        }
      }
    }

    async function update(){
      hydrateLockState();
      updateMarketUI();

      const today = sydneyYMD(getSydneyDateObj());
      const afterClose = isAfterCloseSydney();

      // Locked: render cached or fetch once to create cache
      if (locked){
        const cached = loadFinalResults(today);
        if (cached){
          clearError();
          render(cached, true);
          return;
        }
        try{
          const map = await fetchAllStocks();
          clearError();
          const results = stocks.map(s => ({ manager: s.manager, percent: map.get(s.ticker) }));
          results.sort((a,b) => (b.percent ?? -999) - (a.percent ?? -999));
          saveFinalResults(today, results);
          render(results, true);
          setLastUpdated();
        } catch (e){
          console.error(e);
          showError("Couldn‚Äôt fetch prices right now (proxy blocked). Try again in a minute, or refresh the page.");
        }
        return;
      }

      // Not locked: live fetch + render
      try{
        const map = await fetchAllStocks();
        clearError();

        const results = stocks.map(s => ({ manager: s.manager, percent: map.get(s.ticker) }));
        results.sort((a,b) => (b.percent ?? -999) - (a.percent ?? -999));

        render(results, afterClose);
        setLastUpdated();

        if (afterClose){
          saveFinalResults(today, results);
          locked = true;
          updateMarketUI();
        }
      } catch (e){
        console.error(e);
        showError("Couldn‚Äôt fetch prices right now (proxy blocked). Try again in a minute, or refresh the page.");
      }
    }

    document.getElementById("forceRefreshBtn").addEventListener("click", update);

    update();
    setInterval(update, REFRESH_MS);
  </script>

</body>
</html>
