<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AFL Draft ‚Äî Market Allocation</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#050816;
      --bg1:#060b1f;
      --card:#0b1330cc;
      --stroke:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --accent:#45d4ff;
      --accent2:#7c4dff;
      --good:#2cff9a;
      --bad:#ff4d5a;
      --gold:#FFD700;
      --silver:#C0C0C0;
      --bronze:#CD7F32;
    }

    body{
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(124,77,255,.25), transparent 55%),
        radial-gradient(900px 500px at 85% 10%, rgba(69,212,255,.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .glass{
      background: var(--card);
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      border-radius: 20px;
    }

    .hero{
      position: relative;
      padding: 28px 0 8px;
    }

    .hero-badge{
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      padding: .45rem .75rem;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-weight: 600;
      letter-spacing: .2px;
    }

    .hero-title{
      font-weight: 800;
      letter-spacing: -0.6px;
      line-height: 1.05;
      margin-top: 14px;
      margin-bottom: 10px;
    }

    .hero-sub{
      color: var(--muted);
      max-width: 70ch;
    }

    .pulse-dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
      box-shadow: 0 0 0 0 rgba(44,255,154,.45);
      animation: pulse 1.8s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(44,255,154,.45); }
      70% { box-shadow: 0 0 0 10px rgba(44,255,154,0); }
      100% { box-shadow: 0 0 0 0 rgba(44,255,154,0); }
    }

    .status-pill{
      border-radius: 999px;
      padding: .45rem .75rem;
      font-weight: 700;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      display: inline-flex;
      align-items: center;
      gap: .55rem;
      white-space: nowrap;
    }

    .mini{
      color: var(--muted);
      font-size: .92rem;
    }

    .divider{
      height: 1px;
      background: var(--stroke);
      margin: 12px 0;
    }

    .chart-wrap{
      position: relative;
      height: 360px;
    }

    .table thead th{
      color: rgba(255,255,255,.8);
      font-weight: 800;
      border-bottom-color: var(--stroke) !important;
    }
    .table tbody td{
      border-top-color: rgba(255,255,255,.06) !important;
      vertical-align: middle;
    }

    .rank-chip{
      font-weight: 800;
      border-radius: 999px;
      padding: .3rem .65rem;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      display: inline-flex;
      align-items: center;
      gap: .35rem;
    }

    .pick-chip{
      font-weight: 800;
      border-radius: 999px;
      padding: .3rem .65rem;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(69,212,255,.10);
      color: rgba(255,255,255,.92);
    }

    .medal{
      font-size: 1.05rem;
      line-height: 1;
    }

    .final-banner{
      display:none;
      border: 1px solid rgba(255,77,90,.25);
      background: linear-gradient(90deg, rgba(255,77,90,.15), rgba(255,77,90,.05));
      padding: .75rem 1rem;
      border-radius: 16px;
      font-weight: 800;
      letter-spacing: .3px;
    }

    .skeleton{
      background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.11), rgba(255,255,255,.06));
      background-size: 200% 100%;
      animation: shimmer 1.4s infinite;
      border-radius: 12px;
    }
    @keyframes shimmer{
      0%{ background-position: 200% 0; }
      100%{ background-position: -200% 0; }
    }

    .toast-container{
      position: fixed;
      bottom: 18px;
      right: 18px;
      z-index: 1080;
    }

    .foot{
      color: var(--muted);
      font-size: .92rem;
    }

    /* Make Chart.js text match dark theme */
    canvas { user-select: none; }
  </style>
</head>
<body>

  <div class="container py-4">
    <!-- HERO -->
    <div class="hero">
      <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
        <div>
          <div class="hero-badge">
            <i class="bi bi-graph-up-arrow"></i>
            ASX-powered draft allocation ‚Ä¢ Picks <span class="text-white">7‚Äì14</span>
          </div>

          <h1 class="hero-title display-6">
            üèâ AFL Draft Ladder<br class="d-none d-md-block"/>
            <span style="background:linear-gradient(90deg,var(--accent),var(--accent2)); -webkit-background-clip:text; background-clip:text; color:transparent;">
              The Market Decides
            </span>
          </h1>

          <p class="hero-sub mb-0">
            8 managers. 8 ASX stocks. One trading day. Best daily % change earns the earliest remaining pick.
          </p>
        </div>

        <div class="glass p-3" style="min-width: 280px;">
          <div class="d-flex justify-content-between align-items-center">
            <div class="status-pill" id="marketPill">
              <span class="pulse-dot" id="pulseDot" style="background: var(--good);"></span>
              <span id="marketText">Checking market‚Ä¶</span>
            </div>
            <span class="badge rounded-pill text-bg-dark border" style="border-color: var(--stroke) !important;">
              <i class="bi bi-arrow-repeat"></i> 10m
            </span>
          </div>

          <div class="divider"></div>

          <div class="d-flex justify-content-between">
            <div class="mini">
              <div class="fw-bold text-white">Next update</div>
              <div id="nextUpdate">‚Äî</div>
            </div>
            <div class="mini text-end">
              <div class="fw-bold text-white">Countdown</div>
              <div id="countdown">‚Äî</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="mini">
            <i class="bi bi-clock-history"></i>
            <span class="fw-bold text-white">Last updated:</span>
            <span id="lastUpdated">‚Äî</span>
          </div>

          <div class="mt-3 final-banner" id="finalBanner">
            <i class="bi bi-lock-fill"></i> FINAL RESULTS LOCKED
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN GRID -->
    <div class="row g-3 mt-1">
      <!-- Chart -->
      <div class="col-12 col-lg-7">
        <div class="glass p-3 p-md-4">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
            <div>
              <div class="fw-bold">Live draft allocation</div>
              <div class="mini">Sorted by % change (day). Top performer gets <span class="text-white fw-bold">Pick 7</span>.</div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="badge rounded-pill" style="background:rgba(255,215,0,.15); border:1px solid rgba(255,215,0,.2);">
                <i class="bi bi-trophy-fill"></i> Pick 7 highlighted
              </span>
              <button class="btn btn-sm btn-outline-light" id="forceRefreshBtn">
                <i class="bi bi-arrow-clockwise"></i> Refresh now
              </button>
            </div>
          </div>

          <div class="chart-wrap">
            <canvas id="chart"></canvas>
          </div>

          <div class="mini mt-3">
            Data source: Yahoo Finance quotes (via CORS proxy). This is for fun, not trading.
          </div>
        </div>
      </div>

      <!-- Ladder Table -->
      <div class="col-12 col-lg-5">
        <div class="glass p-3 p-md-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <div class="fw-bold">Draft ladder</div>
              <div class="mini">Final daily % locks at market close (16:00 Sydney).</div>
            </div>
            <span class="badge rounded-pill text-bg-dark border" style="border-color: var(--stroke) !important;">
              <i class="bi bi-shield-check"></i> Commissioner approved
            </span>
          </div>

          <div id="tableLoading" class="mt-3">
            <div class="skeleton mb-2" style="height: 42px;"></div>
            <div class="skeleton mb-2" style="height: 42px;"></div>
            <div class="skeleton mb-2" style="height: 42px;"></div>
            <div class="skeleton mb-2" style="height: 42px;"></div>
            <div class="skeleton mb-2" style="height: 42px;"></div>
          </div>

          <div class="table-responsive" id="tableWrap" style="display:none;">
            <table class="table table-dark table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th style="width: 88px;">Rank</th>
                  <th style="width: 96px;">Pick</th>
                  <th>Manager</th>
                  <th class="text-end">% Day</th>
                </tr>
              </thead>
              <tbody id="ladderBody"></tbody>
            </table>
          </div>

          <div class="divider"></div>

          <div class="d-flex justify-content-between foot">
            <div><i class="bi bi-geo-alt"></i> Sydney time</div>
            <div><i class="bi bi-calendar2-week"></i> Resets next trading day</div>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center mt-4 foot">
      ASX hours: 10:00‚Äì16:00 Sydney ‚Ä¢ Updates every 10 minutes ‚Ä¢ Picks assigned 7‚Äì14
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container">
    <div id="toast" class="toast text-bg-dark border-0 glass" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">‚Äî</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // === CONFIG ===
    const REFRESH_MS = 10 * 60 * 1000; // 10 minutes

    const stocks = [
      { manager: "Jeremy", ticker: "CSL.AX" },
      { manager: "Callum", ticker: "BHP.AX" },
      { manager: "Darrell", ticker: "WBC.AX" },
      { manager: "Damian", ticker: "WES.AX" },
      { manager: "Chris", ticker: "CBA.AX" },
      { manager: "Ryan", ticker: "RIO.AX" },
      { manager: "James", ticker: "MQG.AX" },
      { manager: "Tom", ticker: "NAB.AX" }
    ];

    // === STATE ===
    let chart;
    let locked = false;
    let lastUpdateAt = null;
    let nextUpdateAt = null;

    // Persist lock date per browser so it doesn't "forget" on refresh the same day.
    const LOCK_KEY = "draftMarketLockedDateSydney";

    // === HELPERS: Sydney time ===
    function getSydneyDateObj(){
      const now = new Date();
      return new Date(now.toLocaleString("en-US", { timeZone: "Australia/Sydney" }));
    }
    function sydneyYMD(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function minutesSinceMidnightSydney(){
      const t = getSydneyDateObj();
      return t.getHours() * 60 + t.getMinutes();
    }
    function isMarketOpenSydney(){
      const m = minutesSinceMidnightSydney();
      return m >= 600 && m < 960; // 10:00‚Äì16:00
    }
    function isAfterCloseSydney(){
      return minutesSinceMidnightSydney() >= 960; // 16:00+
    }
    function isBeforeOpenSydney(){
      return minutesSinceMidnightSydney() < 600;
    }

    function updateMarketPill(){
      const open = isMarketOpenSydney();
      const pill = document.getElementById("marketPill");
      const dot = document.getElementById("pulseDot");
      const txt = document.getElementById("marketText");

      if (locked){
        txt.textContent = "Market closed ‚Ä¢ Locked";
        dot.style.background = "var(--bad)";
        dot.style.animation = "none";
        pill.style.background = "rgba(255,77,90,.10)";
        pill.style.borderColor = "rgba(255,77,90,.25)";
        return;
      }

      if (open){
        txt.textContent = "Market OPEN";
        dot.style.background = "var(--good)";
        dot.style.animation = "";
        pill.style.background = "rgba(44,255,154,.08)";
        pill.style.borderColor = "rgba(44,255,154,.20)";
      } else {
        txt.textContent = "Market CLOSED";
        dot.style.background = "var(--bad)";
        dot.style.animation = "none";
        pill.style.background = "rgba(255,77,90,.08)";
        pill.style.borderColor = "rgba(255,77,90,.20)";
      }
    }

    function formatSydneyTime(d){
      return d.toLocaleString("en-AU", {
        timeZone: "Australia/Sydney",
        weekday: "short",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function showToast(message){
      const el = document.getElementById("toast");
      document.getElementById("toastBody").textContent = message;
      const toast = bootstrap.Toast.getOrCreateInstance(el, { delay: 2600 });
      toast.show();
    }

    function setMetaTimes(){
      const now = new Date();
      lastUpdateAt = now;
      nextUpdateAt = new Date(now.getTime() + REFRESH_MS);

      document.getElementById("lastUpdated").textContent =
        lastUpdateAt.toLocaleString("en-AU", { timeZone: "Australia/Sydney" });

      document.getElementById("nextUpdate").textContent =
        nextUpdateAt.toLocaleString("en-AU", { timeZone: "Australia/Sydney", hour:"2-digit", minute:"2-digit" });
    }

    function updateCountdown(){
      const t = getSydneyDateObj();
      const m = minutesSinceMidnightSydney();

      let targetMinutes;
      let label;

      if (locked){
        document.getElementById("countdown").textContent = "Locked";
        return;
      }

      if (isMarketOpenSydney()){
        targetMinutes = 960; // close
        label = "to close";
      } else if (isBeforeOpenSydney()){
        targetMinutes = 600; // open
        label = "to open";
      } else {
        // after close but not locked? (rare, we lock ASAP)
        targetMinutes = 960;
        label = "to lock";
      }

      const diffMin = Math.max(0, targetMinutes - m);
      const hh = Math.floor(diffMin / 60);
      const mm = diffMin % 60;

      document.getElementById("countdown").textContent =
        `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")} ${label}`;
    }

    // === DATA FETCH (ONE REQUEST) ===
    async function fetchAllStocks(){
      const symbols = stocks.map(s => s.ticker).join(",");
      const yahooUrl = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(symbols)}`;
      const proxied = `https://api.allorigins.win/raw?url=${encodeURIComponent(yahooUrl)}`;

      const res = await fetch(proxied, { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to fetch quotes");
      const data = await res.json();

      const map = new Map();
      for (const item of (data.quoteResponse?.result || [])){
        map.set(item.symbol, item.regularMarketChangePercent);
      }
      return map;
    }

    function medalForIndex(i){
      if (i === 0) return `<span class="medal" title="Pick 7 (Gold)"><i class="bi bi-trophy-fill" style="color:var(--gold)"></i></span>`;
      if (i === 1) return `<span class="medal" title="Pick 8 (Silver)"><i class="bi bi-award-fill" style="color:var(--silver)"></i></span>`;
      if (i === 2) return `<span class="medal" title="Pick 9 (Bronze)"><i class="bi bi-award-fill" style="color:var(--bronze)"></i></span>`;
      return `<span class="medal" style="opacity:.55" title="‚Äî"><i class="bi bi-dot"></i></span>`;
    }

    function colorForIndex(i, v){
      if (i === 0) return getComputedStyle(document.documentElement).getPropertyValue('--gold').trim();
      if (i === 1) return getComputedStyle(document.documentElement).getPropertyValue('--silver').trim();
      if (i === 2) return getComputedStyle(document.documentElement).getPropertyValue('--bronze').trim();
      return (v >= 0)
        ? getComputedStyle(document.documentElement).getPropertyValue('--good').trim()
        : getComputedStyle(document.documentElement).getPropertyValue('--bad').trim();
    }

    function render(results, isFinal){
      // Table
      const tbody = document.getElementById("ladderBody");
      tbody.innerHTML = "";

      results.forEach((r, i) => {
        const pick = 7 + i;
        const pct = Number.isFinite(r.percent) ? r.percent : null;

        const pctBadge = pct === null
          ? `<span class="badge rounded-pill text-bg-secondary">N/A</span>`
          : `<span class="badge rounded-pill" style="background:${pct>=0 ? 'rgba(44,255,154,.12)' : 'rgba(255,77,90,.12)'}; border:1px solid ${pct>=0 ? 'rgba(44,255,154,.25)' : 'rgba(255,77,90,.25)'};">
              ${pct.toFixed(2)}%
            </span>`;

        const row = document.createElement("tr");
        row.className = isFinal ? "table-active" : "";
        row.innerHTML = `
          <td>
            <span class="rank-chip">
              ${medalForIndex(i)}
              #${i + 1}
            </span>
          </td>
          <td><span class="pick-chip">Pick ${pick}</span></td>
          <td class="fw-semibold">${r.manager}</td>
          <td class="text-end">${pctBadge}</td>
        `;
        tbody.appendChild(row);
      });

      // Chart
      const labels = results.map((r, i) => `Pick ${7+i} ‚Äî ${r.manager}`);
      const values = results.map(r => Number.isFinite(r.percent) ? r.percent : 0);
      const colors = results.map((r, i) => colorForIndex(i, Number.isFinite(r.percent) ? r.percent : 0));

      const ctx = document.getElementById("chart").getContext("2d");

      const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (c) => `${c.raw.toFixed(2)}%`
            }
          }
        },
        scales: {
          x: {
            ticks: { color: "rgba(255,255,255,.75)" },
            grid: { display: false }
          },
          y: {
            ticks: {
              color: "rgba(255,255,255,.75)",
              callback: (v) => `${v}%`
            },
            grid: { color: "rgba(255,255,255,.07)" }
          }
        }
      };

      if (!chart){
        chart = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [{
              data: values,
              backgroundColor: colors,
              borderColor: "rgba(255,255,255,.10)",
              borderWidth: 1,
              borderRadius: 10
            }]
          },
          options: chartOptions
        });
      } else {
        chart.data.labels = labels;
        chart.data.datasets[0].data = values;
        chart.data.datasets[0].backgroundColor = colors;
        chart.update();
      }

      // Loading UI
      document.getElementById("tableLoading").style.display = "none";
      document.getElementById("tableWrap").style.display = "block";
    }

    function tryAutoUnlockIfNewDay(){
      // If locked in this browser, unlock automatically on a different Sydney date.
      const nowSydney = getSydneyDateObj();
      const today = sydneyYMD(nowSydney);
      const lockedDate = localStorage.getItem(LOCK_KEY);

      if (locked && lockedDate && lockedDate !== today){
        locked = false;
        localStorage.removeItem(LOCK_KEY);
        document.getElementById("finalBanner").style.display = "none";
        showToast("New trading day detected ‚Äî reset unlocked.");
      }
    }

    function lockForToday(){
      const today = sydneyYMD(getSydneyDateObj());
      localStorage.setItem(LOCK_KEY, today);
      locked = true;
      document.getElementById("finalBanner").style.display = "block";
      updateMarketPill();
    }

    function hydrateLockState(){
      const today = sydneyYMD(getSydneyDateObj());
      const lockedDate = localStorage.getItem(LOCK_KEY);
      if (lockedDate === today){
        locked = true;
        document.getElementById("finalBanner").style.display = "block";
      } else {
        locked = false;
        localStorage.removeItem(LOCK_KEY);
      }
      updateMarketPill();
    }

    async function update(){
      tryAutoUnlockIfNewDay();
      updateMarketPill();
      updateCountdown();

      // If after close, we do ONE final pull, render, lock.
      const afterClose = isAfterCloseSydney();

      if (locked) {
        // Still keep UI countdown fresh
        updateCountdown();
        return;
      }

      const percentMap = await fetchAllStocks();

      const results = stocks.map(s => ({
        manager: s.manager,
        percent: percentMap.get(s.ticker)
      }));

      results.sort((a, b) => (b.percent ?? -999) - (a.percent ?? -999));

      render(results, afterClose);

      setMetaTimes();
      updateMarketPill();
      updateCountdown();

      if (afterClose){
        lockForToday();
        showToast("Final results locked at market close.");
      }
    }

    function scheduleMeta(){
      setMetaTimes();
      setInterval(() => {
        if (!nextUpdateAt) return;
        const diff = Math.max(0, nextUpdateAt.getTime() - Date.now());
        const mins = Math.ceil(diff / 60000);
        // keep "next update" feeling alive
        if (!locked) document.getElementById("nextUpdate").textContent = `${mins} min`;
      }, 15000);
    }

    // Force refresh button
    document.getElementById("forceRefreshBtn").addEventListener("click", async () => {
      showToast("Refreshing now‚Ä¶");
      await update();
    });

    // Init
    hydrateLockState();
    scheduleMeta();
    update();
    setInterval(update, REFRESH_MS);
    setInterval(updateCountdown, 1000 * 20); // keep countdown fresh
  </script>
</body>
</html>
