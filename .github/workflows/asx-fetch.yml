name: Fetch ASX Draft Data

on:
  workflow_dispatch:
  schedule:
    # Every 10 minutes (UTC). We'll compute Sydney status inside the script.
    - cron: "*/10 * * * *"

permissions:
  contents: write

concurrency:
  group: asx-draft-data
  cancel-in-progress: false

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Fetch and write data.json
        env:
          TICKERS: "CSL.AX,BHP.AX,WBC.AX,WES.AX,CBA.AX,RIO.AX,MQG.AX,NAB.AX"
        run: |
          node <<'NODE'
          const fs = require("fs");

          const tickers = process.env.TICKERS.split(",");

          // Sydney time helpers
          function getSydneyNow() {
            const now = new Date();
            return new Date(now.toLocaleString("en-US", { timeZone: "Australia/Sydney" }));
          }
          function ymd(d) {
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,"0");
            const day = String(d.getDate()).padStart(2,"0");
            return `${y}-${m}-${day}`;
          }
          function hhmm(d){
            const h = String(d.getHours()).padStart(2,"0");
            const m = String(d.getMinutes()).padStart(2,"0");
            return `${h}:${m}`;
          }
          function minutesSinceMidnight(d){
            return d.getHours()*60 + d.getMinutes();
          }

          const sydneyNow = getSydneyNow();
          const minutes = minutesSinceMidnight(sydneyNow);

          // ASX regular hours: 10:00â€“16:00 Sydney
          const open = 10*60;
          const close = 16*60;

          // We'll "lock" at 16:05 Sydney to ensure the close price is settled.
          const lockMinute = close + 5;

          const isLocked = minutes >= lockMinute;

          // Load existing data.json if present (to keep locked snapshot once locked)
          let existing = null;
          try {
            existing = JSON.parse(fs.readFileSync("data.json","utf8"));
          } catch {}

          const today = ymd(sydneyNow);

          // If already locked for today, do nothing (keep the final snapshot)
          if (existing && existing.locked === true && existing.dateSydney === today) {
            console.log("Already locked for today. Skipping update.");
            process.exit(0);
          }

          // Fetch quotes from Yahoo Finance (server-side, no CORS issues)
          const url = "https://query1.finance.yahoo.com/v7/finance/quote?symbols=" + encodeURIComponent(tickers.join(","));

          async function main(){
            const res = await fetch(url, {
              headers: {
                "User-Agent": "Mozilla/5.0 (GitHub Actions)",
                "Accept": "application/json"
              }
            });

            if (!res.ok) {
              console.error("Yahoo HTTP", res.status);
              process.exit(1);
            }

            const json = await res.json();
            const result = json?.quoteResponse?.result || [];

            const quoteMap = new Map(result.map(r => [r.symbol, r]));

            const quotes = tickers.map(sym => {
              const q = quoteMap.get(sym);
              return {
                symbol: sym,
                percentDay: q?.regularMarketChangePercent ?? null,
                price: q?.regularMarketPrice ?? null,
                prevClose: q?.regularMarketPreviousClose ?? null,
                timeEpoch: q?.regularMarketTime ?? null
              };
            });

            const out = {
              dateSydney: today,
              lastUpdatedSydney: `${today} ${hhmm(sydneyNow)}`,
              locked: isLocked,
              quotes
            };

            fs.writeFileSync("data.json", JSON.stringify(out, null, 2));
            console.log("Wrote data.json", out.lastUpdatedSydney, "locked:", out.locked);
          }

          main().catch(err => {
            console.error(err);
            process.exit(1);
          });
          NODE

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json
          git diff --cached --quiet || (git commit -m "Update ASX draft data" && git push)
