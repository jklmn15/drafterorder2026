name: Fetch ASX Draft Data

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *"   # every 10 minutes (UTC). Sydney logic handled in script.

permissions:
  contents: write

concurrency:
  group: asx-draft-data
  cancel-in-progress: false

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Fetch and write data.json
        env:
          TICKERS: "CSL.AX,BHP.AX,WBC.AX,WES.AX,CBA.AX,RIO.AX,MQG.AX,NAB.AX"
        run: |
          node <<'NODE'
          const fs = require("fs");

          const tickers = process.env.TICKERS.split(",");

          // ===== Sydney time helpers =====
          function getSydneyNow() {
            const now = new Date();
            return new Date(now.toLocaleString("en-US", { timeZone: "Australia/Sydney" }));
          }
          function ymd(d) {
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,"0");
            const day = String(d.getDate()).padStart(2,"0");
            return `${y}-${m}-${day}`;
          }
          function hhmm(d){
            const h = String(d.getHours()).padStart(2,"0");
            const m = String(d.getMinutes()).padStart(2,"0");
            return `${h}:${m}`;
          }
          function minutesSinceMidnight(d){
            return d.getHours()*60 + d.getMinutes();
          }

          const sydneyNow = getSydneyNow();
          const minutes = minutesSinceMidnight(sydneyNow);

          // ASX regular hours: 10:00â€“16:00 Sydney
          const open = 10*60;
          const close = 16*60;

          // Lock at 16:05 Sydney
          const lockMinute = close + 5;
          const isLocked = minutes >= lockMinute;

          const today = ymd(sydneyNow);

          // Load existing data.json so we preserve today's locked snapshot
          let existing = null;
          try { existing = JSON.parse(fs.readFileSync("data.json","utf8")); } catch {}
          if (existing && existing.locked === true && existing.dateSydney === today) {
            console.log("Already locked for today. Skipping update.");
            process.exit(0);
          }

          // ===== Fetch helpers =====
          const yahooUrl = "https://query2.finance.yahoo.com/v7/finance/quote?symbols=" + encodeURIComponent(tickers.join(","));
          const jinaUrl  = "https://r.jina.ai/http://" + yahooUrl.replace(/^https?:\/\//, "");

          async function fetchJson(url) {
            const res = await fetch(url, {
              headers: {
                "User-Agent": "Mozilla/5.0 (GitHub Actions)",
                "Accept": "application/json,text/plain,*/*",
                "Referer": "https://finance.yahoo.com/"
              }
            });
            const text = await res.text();
            return { ok: res.ok, status: res.status, text };
          }

          function parsePossiblyWrappedJson(text) {
            // jina sometimes prepends text; find first "{"
            const idx = text.indexOf("{");
            if (idx === -1) throw new Error("No JSON object found in response");
            return JSON.parse(text.slice(idx));
          }

          async function getYahooQuoteResponse() {
            // Try direct first
            const direct = await fetchJson(yahooUrl);
            if (direct.ok) {
              return JSON.parse(direct.text);
            }
            console.log("Direct Yahoo failed:", direct.status);

            // Fallback via jina
            const viaJina = await fetchJson(jinaUrl);
            if (!viaJina.ok) {
              throw new Error(`Both direct and jina fetch failed. Direct=${direct.status}, Jina=${viaJina.status}`);
            }
            return parsePossiblyWrappedJson(viaJina.text);
          }

          async function main(){
            const json = await getYahooQuoteResponse();
            const result = json?.quoteResponse?.result || [];

            const quoteMap = new Map(result.map(r => [r.symbol, r]));

            const quotes = tickers.map(sym => {
              const q = quoteMap.get(sym);
              return {
                symbol: sym,
                percentDay: q?.regularMarketChangePercent ?? null,
                price: q?.regularMarketPrice ?? null,
                prevClose: q?.regularMarketPreviousClose ?? null,
                timeEpoch: q?.regularMarketTime ?? null
              };
            });

            const out = {
              dateSydney: today,
              lastUpdatedSydney: `${today} ${hhmm(sydneyNow)}`,
              locked: isLocked,
              quotes
            };

            fs.writeFileSync("data.json", JSON.stringify(out, null, 2));
            console.log("Wrote data.json", out.lastUpdatedSydney, "locked:", out.locked);
          }

          main().catch(err => {
            console.error(err);
            process.exit(1);
          });
          NODE

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json
          git diff --cached --quiet || (git commit -m "Update ASX draft data" && git push)
